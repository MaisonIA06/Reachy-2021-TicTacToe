# Configuration de la cam√©ra pour Reachy TicTacToe

## üé• Probl√®me actuel

Le robot ne re√ßoit pas d'images de la cam√©ra, ce qui cause un timeout et un reboot automatique :

```
No image received for 30 sec, going to reboot
```

## ‚úÖ Solution temporaire appliqu√©e

**Mode TEST** activ√© dans `wait_for_img()` :
- Timeout r√©duit de 30s ‚Üí 5s
- Reboot automatique **d√©sactiv√©**
- Le jeu continue m√™me sans cam√©ra (pour tester les mouvements)

---

## üîç Diagnostic de la cam√©ra

### 1. V√©rifier que la cam√©ra est d√©tect√©e

```bash
# Sur le robot
ssh reachy@192.168.18.170

# Lister les p√©riph√©riques vid√©o
ls -l /dev/video*

# V√©rifier avec v4l2
v4l2-ctl --list-devices

# Informations sur la cam√©ra
v4l2-ctl --all
```

### 2. Test avec le SDK Reachy

```python
from reachy_sdk import ReachySDK
import numpy as np

# Connexion
reachy = ReachySDK(host='localhost')

# V√©rifier les cam√©ras disponibles
print("Cam√©ras disponibles:")
print(f"- Left camera: {hasattr(reachy, 'left_camera')}")
print(f"- Right camera: {hasattr(reachy, 'right_camera')}")

# Essayer de lire
try:
    img = reachy.right_camera.read()
    if img is not None:
        print(f"‚úì Image re√ßue: shape={img.shape}, dtype={img.dtype}")
    else:
        print("‚úó Image est None")
except Exception as e:
    print(f"‚úó Erreur: {e}")
```

### 3. Test avec OpenCV direct

```python
import cv2

# Essayer diff√©rents index de cam√©ra
for i in range(5):
    cap = cv2.VideoCapture(i)
    if cap.isOpened():
        ret, frame = cap.read()
        if ret:
            print(f"‚úì Cam√©ra {i} fonctionne: {frame.shape}")
        cap.release()
    else:
        print(f"‚úó Cam√©ra {i} non disponible")
```

---

## üõ†Ô∏è Solutions possibles

### Solution 1 : V√©rifier les permissions

```bash
# Ajouter l'utilisateur au groupe video
sudo usermod -a -G video reachy

# Red√©marrer la session
logout
# Reconnecter
ssh reachy@192.168.18.170
```

### Solution 2 : V√©rifier les drivers RealSense

```bash
# V√©rifier l'installation
dpkg -l | grep realsense

# R√©installer si n√©cessaire
sudo apt update
sudo apt install librealsense2-utils

# Tester avec realsense-viewer
realsense-viewer
```

### Solution 3 : Modifier l'acc√®s √† la cam√©ra dans le code

Si la cam√©ra est sur un autre attribut, modifier dans `tictactoe_playground.py` :

```python
# Ligne ~109 et ~133
# Essayer diff√©rentes fa√ßons d'acc√©der √† la cam√©ra

# Option 1: Via cameras
img = self.reachy.cameras.right.read()

# Option 2: Via right_camera
img = self.reachy.right_camera.read()

# Option 3: Via la teleop
img = self.reachy.head.right_camera.read()
```

### Solution 4 : Utiliser des images de test

Pour tester le syst√®me sans cam√©ra fonctionnelle :

```python
def analyze_board(self):
    """Analyse l'√©tat actuel du plateau de jeu"""
    # MODE TEST: Utiliser une image fixe
    import cv2
    img = cv2.imread('/path/to/test_board.jpg')
    
    if img is None:
        logger.warning('No test image, returning empty board')
        return np.zeros(9, dtype=np.uint8)
    
    # Analyser l'image...
    board, _ = get_board_configuration(img)
    return board.flatten()
```

---

## üîÑ R√©activer le mode production

Une fois la cam√©ra configur√©e, r√©activer le mode normal dans `wait_for_img()` :

```python
def wait_for_img(self):
    """Attend qu'une image soit disponible"""
    start = time.time()
    timeout = 30  # Retour √† 30 secondes
    
    while time.time() - start <= timeout:
        try:
            img = self.reachy.right_camera.read()
            if img is not None and len(img) > 0:
                return
        except Exception:
            pass
        time.sleep(0.1)
        
    logger.warning('No image received for 30 sec, going to reboot.')
    os.system('sudo reboot')  # R√©activer le reboot
```

---

## üìù Configuration RealSense (si applicable)

### Installation compl√®te

```bash
# Ajouter le repository Intel
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-key F6E65AC044F831AC80A06380C8B3A55A6F3EFCDE
sudo add-apt-repository "deb https://librealsense.intel.com/Debian/apt-repo $(lsb_release -cs) main"

# Installer
sudo apt update
sudo apt install librealsense2-dkms librealsense2-utils

# V√©rifier
realsense-viewer
```

### Permissions udev

```bash
# Cr√©er le fichier de r√®gles
sudo wget -O /etc/udev/rules.d/99-realsense-libusb.rules https://raw.githubusercontent.com/IntelRealSense/librealsense/master/config/99-realsense-libusb.rules

# Recharger
sudo udevadm control --reload-rules
sudo udevadm trigger
```

---

## üß™ Tests recommand√©s

### Test 1 : Cam√©ra USB standard

```bash
# Installer fswebcam
sudo apt install fswebcam

# Prendre une photo de test
fswebcam -d /dev/video0 /tmp/test.jpg

# V√©rifier
ls -lh /tmp/test.jpg
```

### Test 2 : RealSense

```bash
# Lister les p√©riph√©riques RealSense
rs-enumerate-devices

# Capturer une frame
rs-capture
```

### Test 3 : Python + OpenCV

```python
import cv2
import numpy as np

cap = cv2.VideoCapture(0)  # Ou 1, 2, etc.

for i in range(10):
    ret, frame = cap.read()
    if ret:
        print(f"‚úì Frame {i}: {frame.shape}")
        cv2.imwrite(f'/tmp/frame_{i}.jpg', frame)
    else:
        print(f"‚úó Frame {i} failed")

cap.release()
```

---

## üéØ Plan d'action recommand√©

### Phase 1 : Tests sans cam√©ra (ACTUEL)
1. ‚úÖ Mode TEST activ√© (pas de reboot)
2. Tester les mouvements du robot
3. Valider que le code goto() fonctionne
4. V√©rifier les comportements √©motionnels

### Phase 2 : Configuration cam√©ra
1. Diagnostiquer le probl√®me cam√©ra
2. Configurer la cam√©ra correctement
3. Valider la lecture d'images
4. Calibrer les coordonn√©es du plateau

### Phase 3 : Production
1. R√©activer le mode normal (timeout 30s)
2. R√©activer le reboot automatique
3. Tests complets avec plateau r√©el
4. Jeu complet fonctionnel

---

## üìû Support

### V√©rification rapide du statut

```bash
# Statut global
python3 << 'EOF'
from reachy_sdk import ReachySDK

reachy = ReachySDK(host='localhost')

print("=== Statut Reachy ===")
print(f"Connect√©: {reachy is not None}")

try:
    img = reachy.right_camera.read()
    print(f"Cam√©ra droite: {'‚úì OK' if img is not None else '‚úó None'}")
except Exception as e:
    print(f"Cam√©ra droite: ‚úó Erreur - {e}")

print("\nPour plus d'aide:")
print("- docs.pollen-robotics.com")
print("- forum.pollen-robotics.com")
EOF
```

---

**Avec le mode TEST activ√©, vous pouvez maintenant tester les mouvements du robot sans craindre les reboots !** üéÆü§ñ

