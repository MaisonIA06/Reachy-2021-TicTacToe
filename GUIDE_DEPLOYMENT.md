# üöÄ Guide de D√©ploiement sur Reachy

Ce guide vous explique comment transf√©rer et configurer le projet TicTacToe sur votre robot Reachy.

---

## üìã Pr√©requis

### Sur votre PC de d√©veloppement
- ‚úÖ Python 3.8+
- ‚úÖ Acc√®s r√©seau √† Reachy
- ‚úÖ Cl√© SSH configur√©e (recommand√©)

### Sur Reachy
- ‚úÖ Reachy V1 avec SDK 2021
- ‚úÖ Ubuntu 20.04+ 
- ‚úÖ Connexion r√©seau
- ‚úÖ Cam√©ra droite fonctionnelle

---

## üîß √âTAPE 1 : Pr√©paration sur votre PC

### 1.1 R√©soudre le probl√®me EdgeTPU

Les mod√®les actuels sont compil√©s pour EdgeTPU. Vous devez les convertir pour CPU :

```bash
cd /home/mia/Bureau/reachy-2019-tictactoe

# Installer TensorFlow (si pas d√©j√† install√©)
pip install tensorflow

# Convertir les mod√®les pour CPU
python scripts/convert_models_for_cpu.py
```

**R√©sultat attendu :**
```
‚úÖ Mod√®les CPU cr√©√©s avec succ√®s !
‚úì ttt-boxes.tflite fonctionne (CPU)
‚úì ttt-valid-board.tflite fonctionne (CPU)
```

### 1.2 V√©rifier les fichiers

```bash
# V√©rifier que les mod√®les sont cr√©√©s
ls -lh reachy_tictactoe/models/*.tflite

# Vous devriez voir:
# ttt-boxes.tflite              (~9 MB - nouveau, CPU)
# ttt-valid-board.tflite        (~9 MB - nouveau, CPU)
# ttt-boxes-edgetpu-BACKUP.tflite     (ancien, EdgeTPU)
# ttt-valid-board-edgetpu-BACKUP.tflite (ancien, EdgeTPU)
```

---

## üîÑ √âTAPE 2 : Transfert vers Reachy

### 2.1 Identifier l'adresse IP de Reachy

```bash
# Sur Reachy (via clavier/√©cran ou SSH)
hostname -I

# Exemple de sortie: 192.168.1.42
```

### 2.2 Configurer l'acc√®s SSH (recommand√©)

```bash
# Sur votre PC
# Copier votre cl√© publique sur Reachy (facilite les transferts)
ssh-copy-id reachy@<IP_REACHY>

# Exemple:
ssh-copy-id reachy@192.168.1.42
```

### 2.3 Transf√©rer le projet complet

```bash
# Sur votre PC
cd /home/mia/Bureau

# Option A: Transf√©rer tout le projet
scp -r reachy-2019-tictactoe reachy@<IP_REACHY>:~/

# Option B: Transf√©rer uniquement les fichiers n√©cessaires (plus rapide)
ssh reachy@<IP_REACHY> "mkdir -p ~/reachy-2019-tictactoe"

# Transf√©rer les fichiers essentiels
scp -r reachy-2019-tictactoe/reachy_tictactoe reachy@<IP_REACHY>:~/reachy-2019-tictactoe/
scp reachy-2019-tictactoe/requirements.txt reachy@<IP_REACHY>:~/reachy-2019-tictactoe/
scp reachy-2019-tictactoe/setup.py reachy@<IP_REACHY>:~/reachy-2019-tictactoe/
scp -r reachy-2019-tictactoe/scripts reachy@<IP_REACHY>:~/reachy-2019-tictactoe/
```

**Temps de transfert :** ~2-5 minutes selon la connexion

---

## üéØ √âTAPE 3 : Installation sur Reachy

### 3.1 Se connecter √† Reachy

```bash
# Sur votre PC
ssh reachy@<IP_REACHY>
```

### 3.2 Cr√©er un environnement virtuel

```bash
# Sur Reachy
cd ~/reachy-2019-tictactoe

# Cr√©er l'environnement virtuel
python3 -m venv venv

# Activer l'environnement
source venv/bin/activate

# Votre prompt devrait changer: (venv) reachy@reachy:~/reachy-2019-tictactoe$
```

### 3.3 Installer les d√©pendances

```bash
# Sur Reachy (avec venv activ√©)
pip install --upgrade pip

# Installer les d√©pendances
pip install -r requirements.txt

# Installer le package en mode d√©veloppement
pip install -e .
```

**‚è±Ô∏è Dur√©e :** ~5-10 minutes

### 3.4 V√©rifier l'installation

```bash
# V√©rifier que le package est install√©
pip list | grep reachy

# R√©sultat attendu:
# reachy-tictactoe    2.0.0
# reachy-sdk          x.x.x
```

---

## üìê √âTAPE 4 : Calibration des coordonn√©es

La calibration est **ESSENTIELLE** car les coordonn√©es des cases d√©pendent de :
- La position de la cam√©ra
- L'angle de vue
- La taille et position de votre plateau

### 4.1 Pr√©parer le plateau

1. **Placer le plateau** devant Reachy (distance ~50-70 cm)
2. **Bien √©clairer** la zone (lumi√®re naturelle ou artificielle uniforme)
3. **Nettoyer le plateau** (pas de pi√®ces pos√©es)

### 4.2 Lancer la calibration

```bash
# Sur Reachy (avec venv activ√©)
cd ~/reachy-2019-tictactoe

# Lancer le script de calibration
python scripts/calibrate_board.py --host localhost
```

### 4.3 Utiliser l'interface de calibration

Une fen√™tre s'ouvre montrant la vue de la cam√©ra :

1. **Cliquez et glissez** pour tracer un rectangle autour de la premi√®re case (0,0)
2. **R√©p√©tez** pour les 8 autres cases dans l'ordre :
   ```
   (0,0) -> (0,1) -> (0,2)
   (1,0) -> (1,1) -> (1,2)
   (2,0) -> (2,1) -> (2,2)
   ```
3. **Appuyez sur 's'** pour sauvegarder
4. Les coordonn√©es sont sauvegard√©es dans `/tmp/board_calibration.py`

### 4.4 Mettre √† jour vision.py

```bash
# Sur Reachy
# Copier le code affich√© par le script de calibration

# √âditer vision.py
nano ~/reachy-2019-tictactoe/reachy_tictactoe/vision.py

# Trouver la ligne ~165 avec:
# board_cases = np.array((
#     ((209, 316, 253, 346), ...),
#     ...
# ))

# Remplacer par les nouvelles coordonn√©es
# Sauvegarder: Ctrl+O, Entr√©e, Ctrl+X
```

**Exemple de coordonn√©es calibr√©es :**
```python
board_cases = np.array((
    ((210, 320, 250, 345), (320, 430, 250, 345), (430, 535, 250, 345)),  # Ligne 0
    ((190, 310, 345, 460), (310, 430, 345, 460), (430, 540, 345, 460)),  # Ligne 1
    ((175, 300, 460, 585), (300, 430, 460, 585), (430, 555, 460, 585)),  # Ligne 2
))
```

---

## ‚úÖ √âTAPE 5 : Test du syst√®me

### 5.1 Test rapide de la vision

```bash
# Sur Reachy
cd ~/reachy-2019-tictactoe
source venv/bin/activate

# Tester la d√©tection
python -c "
from reachy_sdk import ReachySDK
from reachy_tictactoe.vision import get_board_configuration, is_board_valid
import time

reachy = ReachySDK(host='localhost')
reachy.turn_on('head')
reachy.head.look_at(x=0.5, y=0, z=-0.6, duration=1.0)
time.sleep(1.5)

img = reachy.right_camera.last_frame
print('Image captur√©e:', img.shape)

valid = is_board_valid(img)
print('Plateau valide:', valid)

board, _ = get_board_configuration(img)
print('Configuration du plateau:')
print(board)
"
```

**R√©sultat attendu :**
```
Image captur√©e: (720, 1280, 3)
Plateau valide: True
Configuration du plateau:
[[0 0 0]
 [0 0 0]
 [0 0 0]]
```

### 5.2 Test du mouvement

```bash
# Test minimal du bras
python -c "
from reachy_sdk import ReachySDK
import time

reachy = ReachySDK(host='localhost')
reachy.turn_on('r_arm')
time.sleep(0.5)

print('‚úì Bras activ√©')
print('Temp√©ratures:', {j.name: j.temperature for j in reachy.r_arm.joints.values()})

reachy.turn_off_smoothly('r_arm')
print('‚úì Test termin√©')
"
```

---

## üéÆ √âTAPE 6 : Lancer le jeu

### 6.1 Premier lancement (mode test)

```bash
# Sur Reachy
cd ~/reachy-2019-tictactoe
source venv/bin/activate

# Lancer avec logs
python -m reachy_tictactoe.game_launcher --log-file /tmp/tictactoe --host localhost
```

**Le jeu va :**
1. Activer la t√™te et le bras droit
2. Attendre que le plateau soit vide
3. Faire un tirage au sort (qui commence)
4. Commencer la partie !

### 6.2 Arr√™t du jeu

```bash
# Appuyer sur Ctrl+C pour arr√™ter proprement
# Le robot va d√©sactiver tous les moteurs
```

### 6.3 Consulter les logs

```bash
# Voir les logs en temps r√©el
tail -f /tmp/tictactoe*.log

# Ou ouvrir le dernier fichier log
ls -lt /tmp/tictactoe*.log | head -1
```

---

## üîß √âTAPE 7 : Configuration en service (optionnel)

Pour que le jeu se lance automatiquement au d√©marrage de Reachy :

### 7.1 Cr√©er le fichier service

```bash
# Sur Reachy
sudo nano /etc/systemd/system/tictactoe.service
```

**Contenu :**
```ini
[Unit]
Description=TicTacToe Playground Service
Wants=network-online.target
After=network.target network-online.target

[Service]
Type=simple
User=reachy
Group=reachy
WorkingDirectory=/home/reachy/reachy-2019-tictactoe
Environment="PATH=/home/reachy/reachy-2019-tictactoe/venv/bin:$PATH"
ExecStart=/home/reachy/reachy-2019-tictactoe/venv/bin/python -m reachy_tictactoe.game_launcher --log-file /home/reachy/tictactoe_logs/game
Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

### 7.2 Activer le service

```bash
# Cr√©er le dossier de logs
mkdir -p ~/tictactoe_logs

# Recharger systemd
sudo systemctl daemon-reload

# Activer le service (d√©marrage automatique)
sudo systemctl enable tictactoe.service

# D√©marrer le service
sudo systemctl start tictactoe.service

# V√©rifier le statut
sudo systemctl status tictactoe.service

# Voir les logs
sudo journalctl -u tictactoe.service -f
```

### 7.3 Commandes utiles

```bash
# Arr√™ter le service
sudo systemctl stop tictactoe.service

# Red√©marrer le service
sudo systemctl restart tictactoe.service

# D√©sactiver le d√©marrage automatique
sudo systemctl disable tictactoe.service
```

---

## üêõ D√©pannage

### Probl√®me : "No module named 'reachy_sdk'"

**Solution :**
```bash
source ~/reachy-2019-tictactoe/venv/bin/activate
pip install reachy-sdk
```

### Probl√®me : "RuntimeError: edgetpu-custom-op"

**Solution :** Les mod√®les ne sont pas convertis pour CPU
```bash
# Sur votre PC (pas sur Reachy)
cd /home/mia/Bureau/reachy-2019-tictactoe
python scripts/convert_models_for_cpu.py

# Transf√©rer les nouveaux mod√®les
scp reachy_tictactoe/models/*.tflite reachy@<IP>:~/reachy-2019-tictactoe/reachy_tictactoe/models/
```

### Probl√®me : Cam√©ra ne r√©pond pas

**Solution :**
```bash
# V√©rifier la connexion cam√©ra
python -c "from reachy_sdk import ReachySDK; r = ReachySDK('localhost'); print(r.right_camera.last_frame)"

# Si None, red√©marrer Reachy
sudo reboot
```

### Probl√®me : D√©tection incorrecte des pi√®ces

**Solution :** Recalibrer les coordonn√©es
```bash
python scripts/calibrate_board.py --host localhost
# Puis mettre √† jour vision.py avec les nouvelles coordonn√©es
```

### Probl√®me : Temp√©ratures moteurs √©lev√©es

**R√©sultat attendu :** Le robot entre automatiquement en mode refroidissement √† 50¬∞C

**Pr√©vention :**
- Faire des pauses entre les parties
- V√©rifier la ventilation de Reachy
- R√©duire la fr√©quence de jeu

---

## üìä Checklist finale

Avant de d√©clarer le syst√®me pr√™t :

- [ ] ‚úÖ Mod√®les convertis pour CPU
- [ ] ‚úÖ Projet transf√©r√© sur Reachy
- [ ] ‚úÖ D√©pendances install√©es dans venv
- [ ] ‚úÖ Coordonn√©es calibr√©es
- [ ] ‚úÖ Test de vision r√©ussi
- [ ] ‚úÖ Test de mouvement r√©ussi
- [ ] ‚úÖ Premier jeu lanc√© avec succ√®s
- [ ] ‚úÖ Service configur√© (optionnel)

---

## üéØ Prochaines √©tapes

### Pour am√©liorer la pr√©cision de d√©tection

1. **Collecter vos propres images :**
   ```bash
   # Utiliser le notebook de collecte
   jupyter notebook notebooks/Collect_training_images.ipynb
   ```

2. **Entra√Æner les mod√®les :**
   ```bash
   # Utiliser le notebook d'entra√Ænement
   jupyter notebook notebooks/Train_classifier.ipynb
   ```

3. **Remplacer les mod√®les par les v√¥tres**

### Pour personnaliser le comportement

- Modifier `behavior.py` : ajouter de nouveaux comportements √©motionnels
- Modifier `rl_agent.py` : changer la strat√©gie de jeu
- Modifier `moves/` : enregistrer de nouvelles trajectoires

---

## üìû Support

**En cas de probl√®me :**

1. Consulter les logs : `/tmp/tictactoe*.log`
2. V√©rifier la documentation : `README.md`, `QUICK_START.md`
3. Forum Pollen Robotics : https://forum.pollen-robotics.com/
4. GitHub Issues : (votre repository)

---

## üéâ F√©licitations !

Votre robot Reachy est maintenant pr√™t √† jouer au morpion ! ü§ñüéÆ

**Amusez-vous bien et n'h√©sitez pas √† partager vos am√©liorations !**

