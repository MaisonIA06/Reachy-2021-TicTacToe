# Conversion des mod√®les EdgeTPU vers CPU

## üö® Probl√®me

Les mod√®les `.tflite` actuels sont compil√©s pour **EdgeTPU** et contiennent des op√©rations sp√©cifiques (`edgetpu-custom-op`) qui ne peuvent pas fonctionner sur un NUC sans acc√©l√©rateur EdgeTPU.

Erreur typique :
```
RuntimeError: Encountered unresolved custom op: edgetpu-custom-op
```

## üí° Solutions

### Solution 1 : Reconvertir les mod√®les pour CPU (Recommand√©)

Si vous avez acc√®s aux mod√®les originaux (avant compilation EdgeTPU), vous pouvez les reconvertir.

#### √âtapes :

1. **Localiser les mod√®les originaux**
   - Fichiers `.pb` (TensorFlow)
   - Fichiers `.h5` (Keras)
   - Mod√®les SavedModel

2. **Convertir en TensorFlow Lite (CPU)**

```python
import tensorflow as tf

# Exemple avec un mod√®le SavedModel
converter = tf.lite.TFLiteConverter.from_saved_model('path/to/saved_model')

# Configuration pour CPU
converter.optimizations = [tf.lite.Optimize.DEFAULT]
converter.target_spec.supported_ops = [
    tf.lite.OpsSet.TFLITE_BUILTINS,  # Op√©rations TFLite standard
]

# Convertir
tflite_model = converter.convert()

# Sauvegarder
with open('ttt-boxes-cpu.tflite', 'wb') as f:
    f.write(tflite_model)
```

3. **Remplacer les mod√®les**

```bash
cd reachy_tictactoe/models/
# Sauvegarder les anciens mod√®les
mv ttt-boxes.tflite ttt-boxes-edgetpu.tflite.backup
mv ttt-valid-board.tflite ttt-valid-board-edgetpu.tflite.backup

# Copier les nouveaux mod√®les
cp /path/to/ttt-boxes-cpu.tflite ttt-boxes.tflite
cp /path/to/ttt-valid-board-cpu.tflite ttt-valid-board.tflite
```

---

### Solution 2 : Utiliser des mod√®les de remplacement simples (Temporaire)

Si vous n'avez pas acc√®s aux mod√®les originaux, utilisez des mod√®les de remplacement simples pour tester le syst√®me.

#### Cr√©er automatiquement :

```bash
cd ~/dev/Reachy-2021-TicTacToe
python scripts/create_fallback_models.py
```

**‚ö†Ô∏è ATTENTION** : Ces mod√®les sont des placeholders et ne d√©tectent PAS vraiment les pi√®ces. Ils sont uniquement pour tester que le syst√®me fonctionne sans EdgeTPU.

---

### Solution 3 : Ajouter un acc√©l√©rateur EdgeTPU USB

Si vous souhaitez utiliser les mod√®les EdgeTPU existants, vous pouvez ajouter un acc√©l√©rateur.

#### Mat√©riel n√©cessaire :
- [Coral USB Accelerator](https://coral.ai/products/accelerator/)

#### Installation :

1. **Brancher l'acc√©l√©rateur** sur un port USB 3.0

2. **Installer le runtime EdgeTPU**

```bash
# Ajouter le d√©p√¥t Coral
echo "deb https://packages.cloud.google.com/apt coral-edgetpu-stable main" | sudo tee /etc/apt/sources.list.d/coral-edgetpu.list
curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -

# Installer
sudo apt update
sudo apt install libedgetpu1-std

# Version haute performance (chauffe plus)
# sudo apt install libedgetpu1-max
```

3. **Installer la biblioth√®que Python**

```bash
pip install pycoral
```

4. **Modifier le code vision.py**

Utiliser `pycoral` au lieu de `tflite_runtime` :

```python
from pycoral.utils import edgetpu
from pycoral.adapters import common
from pycoral.adapters import classify

# Charger le mod√®le avec EdgeTPU
interpreter = edgetpu.make_interpreter('model_edgetpu.tflite')
interpreter.allocate_tensors()
```

---

## üîç V√©rifier le type de mod√®le

Pour v√©rifier si un mod√®le est compil√© pour EdgeTPU :

```python
import tflite_runtime.interpreter as tflite

try:
    interpreter = tflite.Interpreter('model.tflite')
    interpreter.allocate_tensors()
    print("‚úì Mod√®le compatible CPU")
except RuntimeError as e:
    if 'edgetpu-custom-op' in str(e):
        print("‚úó Mod√®le compil√© pour EdgeTPU")
    else:
        print(f"‚úó Autre erreur: {e}")
```

---

## üìù Nomenclature des mod√®les

Convention de nommage recommand√©e :

- `model-cpu.tflite` : Mod√®le pour CPU
- `model-edgetpu.tflite` : Mod√®le pour EdgeTPU
- `model.tflite` : Mod√®le actuel (par d√©faut)

---

## üéØ Performances compar√©es

| Mat√©riel | Inf√©rence | Latence |
|----------|-----------|---------|
| NUC CPU (i5) | ~50-100ms | Acceptable |
| NUC CPU (i7) | ~30-50ms | Bonne |
| EdgeTPU | ~5-10ms | Excellente |

Pour le jeu de morpion, les performances CPU sont largement suffisantes.

---

## ‚ùì FAQ

### Q: Puis-je utiliser TensorFlow complet au lieu de TFLite ?
R: Oui, mais c'est plus lourd. TFLite est recommand√© pour la robotique embarqu√©e.

### Q: O√π trouver les mod√®les originaux ?
R: Ils devraient √™tre dans le d√©p√¥t original du projet ou dans les notebooks de training.

### Q: Les mod√®les CPU sont-ils moins pr√©cis ?
R: Non, la pr√©cision est identique. Seule la vitesse d'ex√©cution diff√®re.

### Q: Puis-je utiliser un GPU √† la place ?
R: Oui, avec TensorFlow GPU, mais c'est plus complexe √† configurer.

---

## üîó Ressources

- [TensorFlow Lite Guide](https://www.tensorflow.org/lite/guide)
- [Coral EdgeTPU Documentation](https://coral.ai/docs/)
- [Model Converter](https://www.tensorflow.org/lite/convert)
- [Optimization Guide](https://www.tensorflow.org/lite/performance/best_practices)

---

## üìû Support

Si vous avez des difficult√©s :

1. V√©rifiez les logs : `/tmp/tictactoe*.log`
2. Testez avec les mod√®les de fallback
3. Consultez le forum Pollen Robotics
4. Ouvrez une issue sur GitHub

