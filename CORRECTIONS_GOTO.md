# Corrections de l'erreur ValueError: goal_positions keys should be Joint!

## üêõ Probl√®me identifi√©

L'erreur suivante se produisait lors de l'ex√©cution :
```
ValueError: goal_positions keys should be Joint!
```

**Cause** : La m√©thode `goto()` du SDK `reachy-sdk` attend un dictionnaire dont les **cl√©s sont des objets `Joint`**, et non des cha√Ænes de caract√®res.

## ‚úÖ Solution appliqu√©e

Toutes les utilisations de `goto()` ont √©t√© corrig√©es pour utiliser des objets `Joint` au lieu de cha√Ænes.

### Exemple de correction

#### ‚ùå Avant (incorrect)
```python
goto(
    goal_positions={
        'head.l_antenna': 0.0,
        'head.r_antenna': 0.0,
    },
    duration=2.0,
    interpolation_mode=InterpolationMode.MINIMUM_JERK,
)
```

#### ‚úÖ Apr√®s (correct)
```python
goto(
    goal_positions={
        self.reachy.head.l_antenna: 0.0,
        self.reachy.head.r_antenna: 0.0,
    },
    duration=2.0,
    interpolation_mode=InterpolationMode.MINIMUM_JERK,
)
```

---

## üìù Fichiers corrig√©s

### 1. `reachy_tictactoe/tictactoe_playground.py`

#### Modifications principales :

1. **M√©thode `setup()`** (ligne 49-57)
   - Correction: Antennes utilisant objets Joint

2. **M√©thode `shuffle_board()` ‚Üí `ears_no()`** (ligne 234-239)
   - Correction: Animation des antennes

3. **M√©thode `play_pawn()`** (ligne 341-348, 394-401)
   - Correction: Animation et reset des antennes
   - Correction: Ajustement positions bras

4. **Nouvelle m√©thode `_get_joint_by_name()`** (ligne 563-598)
   - Ajout d'une m√©thode utilitaire pour r√©cup√©rer un objet Joint par son nom
   - Supporte l'acc√®s via `reachy.joints[name]` ou acc√®s hi√©rarchique

5. **M√©thode `goto_position()`** (ligne 508-536)
   - Correction majeure : Conversion des noms de joints en objets Joint
   - Utilise `_get_joint_by_name()` pour chaque joint

6. **M√©thode `play_trajectory()`** (ligne 600-633)
   - Correction majeure : Conversion de tous les joints en objets
   - Gestion des erreurs si un joint n'est pas trouv√©

7. **M√©thodes `close_gripper()` et `open_gripper()`** (ligne 655-673)
   - Correction: Utilisation de `self.reachy.r_arm.r_gripper`

8. **M√©thodes `enter_sleep_mode()` et `leave_sleep_mode()`** (ligne 749-776)
   - Correction: Animation idle et sortie de veille

**Total : 11 corrections dans ce fichier**

---

### 2. `reachy_tictactoe/behavior.py`

#### Modifications principales :

1. **Fonction `head_home()`** (ligne 65-74)
   - Correction: Reset des antennes

2. **Fonction `sad()`** (ligne 98-107)
   - Correction: Boucle d'animation tristesse

3. **Fonction `happy()`** (ligne 127-136)
   - Correction: Animation joyeuse

4. **Fonction `surprise()`** (ligne 154-163)
   - Correction: Mouvement asym√©trique

5. **Fonction `celebrate()`** (ligne 183-203, 211-220)
   - Correction: Mouvements haut-bas r√©p√©t√©s
   - Correction: Animation ondulante finale

6. **Fonction `thinking()`** (ligne 242-251)
   - Correction: Animation de r√©flexion

7. **Fonction `wave_hello()`** (ligne 269-289)
   - Correction: Animation de salut (2 mouvements)

8. **Fonction `impatient()`** (ligne 307-327)
   - Correction: Mouvements saccad√©s (2 mouvements)

**Total : 12 corrections dans ce fichier**

---

## üîß Nouvelles fonctionnalit√©s ajout√©es

### M√©thode `_get_joint_by_name(joint_name)`

Cette m√©thode permet de r√©cup√©rer un objet `Joint` √† partir de son nom (cha√Æne).

```python
def _get_joint_by_name(self, joint_name):
    """
    R√©cup√®re un objet Joint √† partir de son nom
    
    Args:
        joint_name: Nom du joint (ex: 'r_arm.r_shoulder_pitch')
        
    Returns:
        Joint: Objet Joint ou None si non trouv√©
    """
    try:
        # Essayer d'acc√©der au joint via le dictionnaire joints
        if joint_name in self.reachy.joints:
            return self.reachy.joints[joint_name]
        
        # M√©thode alternative: acc√®s hi√©rarchique
        parts = joint_name.split('.')
        if len(parts) == 2:
            part_name, joint_short_name = parts
            if part_name == 'r_arm' and hasattr(self.reachy, 'r_arm'):
                if joint_short_name in self.reachy.r_arm.joints:
                    return self.reachy.r_arm.joints[joint_short_name]
            elif part_name == 'l_arm' and hasattr(self.reachy, 'l_arm'):
                if joint_short_name in self.reachy.l_arm.joints:
                    return self.reachy.l_arm.joints[joint_short_name]
            elif part_name == 'head' and hasattr(self.reachy, 'head'):
                if joint_short_name in self.reachy.head.joints:
                    return self.reachy.head.joints[joint_short_name]
                    
        logger.warning(f'Joint not found: {joint_name}')
        return None
        
    except Exception as e:
        logger.error(f'Error accessing joint {joint_name}: {e}')
        return None
```

**Avantages** :
- Permet de g√©rer les anciens mouvements enregistr√©s (fichiers `.npz`)
- Conversion automatique des noms vers des objets Joint
- Gestion d'erreur robuste

---

## üìä R√©sum√© des corrections

| Fichier | Nombre de corrections | Type |
|---------|----------------------|------|
| `tictactoe_playground.py` | 11 | Appels directs `goto()` + m√©thodes |
| `behavior.py` | 12 | Fonctions de comportement |
| **TOTAL** | **23** | - |

---

## üß™ Tests recommand√©s

### 1. Test unitaire - Acc√®s aux joints

```python
from reachy_sdk import ReachySDK

def test_joint_access():
    """Teste l'acc√®s aux objets Joint"""
    reachy = ReachySDK(host='localhost')
    
    # Test acc√®s direct
    assert hasattr(reachy.head, 'l_antenna')
    assert hasattr(reachy.head, 'r_antenna')
    assert hasattr(reachy.r_arm, 'r_shoulder_pitch')
    assert hasattr(reachy.r_arm, 'r_gripper')
    
    # Test que ce sont bien des objets Joint
    from reachy_sdk.joint import Joint
    assert isinstance(reachy.head.l_antenna, Joint)
    
    print("‚úì Tous les tests d'acc√®s aux joints r√©ussis")
```

### 2. Test manuel - Mouvement simple

```python
from reachy_sdk import ReachySDK
from reachy_sdk.trajectory import goto
from reachy_sdk.trajectory.interpolation import InterpolationMode
import numpy as np

def test_simple_movement():
    """Teste un mouvement simple avec goto()"""
    reachy = ReachySDK(host='localhost')
    reachy.turn_on('head')
    
    try:
        # Test mouvement des antennes
        goto(
            goal_positions={
                reachy.head.l_antenna: np.deg2rad(45),
                reachy.head.r_antenna: np.deg2rad(-45),
            },
            duration=1.0,
            interpolation_mode=InterpolationMode.MINIMUM_JERK,
        )
        print("‚úì Mouvement des antennes r√©ussi")
        
        # Retour position neutre
        goto(
            goal_positions={
                reachy.head.l_antenna: 0.0,
                reachy.head.r_antenna: 0.0,
            },
            duration=1.0,
            interpolation_mode=InterpolationMode.MINIMUM_JERK,
        )
        print("‚úì Retour position neutre r√©ussi")
        
    finally:
        reachy.turn_off_smoothly('head')
```

### 3. Test d'int√©gration - Comportement complet

```python
from reachy_tictactoe import TictactoePlayground

def test_behavior():
    """Teste un comportement complet"""
    with TictactoePlayground(host='localhost') as playground:
        playground.setup()
        
        # Test comportement joyeux
        from reachy_tictactoe import behavior
        behavior.happy(playground.reachy)
        print("‚úì Comportement 'happy' r√©ussi")
        
        # Test comportement triste
        behavior.sad(playground.reachy)
        print("‚úì Comportement 'sad' r√©ussi")
```

### 4. Test de la m√©thode `_get_joint_by_name()`

```python
from reachy_tictactoe import TictactoePlayground

def test_get_joint_by_name():
    """Teste la m√©thode de r√©cup√©ration des joints par nom"""
    with TictactoePlayground(host='localhost') as playground:
        # Test avec diff√©rents noms
        joint_names = [
            'head.l_antenna',
            'head.r_antenna',
            'r_arm.r_shoulder_pitch',
            'r_arm.r_gripper',
        ]
        
        for name in joint_names:
            joint = playground._get_joint_by_name(name)
            assert joint is not None, f"Joint {name} not found"
            print(f"‚úì Joint {name} trouv√©: {joint}")
        
        print("‚úì Tous les joints ont √©t√© trouv√©s")
```

### 5. Test manuel - Jeu complet

```bash
# Lancer le jeu et v√©rifier qu'il fonctionne sans erreur
python -m reachy_tictactoe.game_launcher --log-file /tmp/tictactoe_test

# V√©rifier les logs
tail -f /tmp/tictactoe_test-*.log
```

---

## üöÄ V√©rification apr√®s correction

### Commandes pour v√©rifier

```bash
# 1. Test d'importation
python -c "from reachy_tictactoe import TictactoePlayground; print('‚úì Import OK')"

# 2. Test avec linter
python -m flake8 reachy_tictactoe/tictactoe_playground.py
python -m flake8 reachy_tictactoe/behavior.py

# 3. Lancement du jeu
python -m reachy_tictactoe.game_launcher --log-file /tmp/tictactoe
```

---

## üìö R√©f√©rences

- [Documentation SDK Reachy](https://docs.pollen-robotics.com/)
- [API goto()](https://docs.pollen-robotics.com/sdk/api/trajectory/)
- [Objets Joint](https://docs.pollen-robotics.com/sdk/api/joint/)

---

## ‚úÖ Statut

**Toutes les corrections ont √©t√© appliqu√©es avec succ√®s !**

- ‚úÖ 23 corrections dans 2 fichiers
- ‚úÖ Nouvelle m√©thode utilitaire `_get_joint_by_name()`
- ‚úÖ Aucune erreur de linting
- ‚úÖ Code pr√™t pour les tests

**Le code est maintenant conforme aux exigences du SDK reachy-sdk 2021.**

