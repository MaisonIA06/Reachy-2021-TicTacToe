# Guide de d√©ploiement sur le robot Reachy

## üìã Situation actuelle

D'apr√®s les logs, le code corrig√© n'a pas encore √©t√© d√©ploy√© sur le robot. Le robot utilise encore l'ancienne version avec l'erreur `ValueError: goal_positions keys should be Joint!`.

## üöÄ √âtapes de d√©ploiement

### 1. Transf√©rer le code corrig√© vers le robot

Depuis votre machine locale (NUC ou autre), transf√©rez les fichiers vers le robot :

```bash
# Depuis votre machine locale
cd /home/mia/Bureau/reachy-2019-tictactoe

# Transf√©rer les fichiers corrig√©s vers le robot
scp -r reachy_tictactoe/ reachy@192.168.18.170:~/dev/Reachy-2021-TicTacToe/
```

**OU** si vous √™tes d√©j√† connect√© en SSH au robot :

```bash
# Sur le robot
cd ~/dev/Reachy-2021-TicTacToe

# Tirer les derni√®res modifications (si vous utilisez git)
git pull

# OU copier manuellement les fichiers modifi√©s
```

### 2. V√©rifier les fichiers sur le robot

```bash
# Se connecter au robot
ssh reachy@192.168.18.170

# Aller dans le r√©pertoire du projet
cd ~/dev/Reachy-2021-TicTacToe

# V√©rifier que les fichiers corrig√©s sont pr√©sents
ls -l reachy_tictactoe/tictactoe_playground.py
ls -l reachy_tictactoe/behavior.py

# V√©rifier la date de modification (doit √™tre r√©cente)
stat reachy_tictactoe/tictactoe_playground.py
```

### 3. R√©installer le package

```bash
# Sur le robot
cd ~/dev/Reachy-2021-TicTacToe
source venv/bin/activate

# R√©installer le package
pip install -e .

# Ou forcer la r√©installation
pip install --force-reinstall -e .
```

### 4. Tester l'importation

```bash
# Test rapide
python -c "from reachy_tictactoe import TictactoePlayground; print('‚úì Import OK')"
```

### 5. R√©soudre le probl√®me de cam√©ra

D'apr√®s les logs, il y a un timeout cam√©ra :
```
No image received for 30 sec, going to reboot
```

#### Solution 1 : V√©rifier la cam√©ra

```bash
# Sur le robot
python3 << EOF
from reachy_sdk import ReachySDK
reachy = ReachySDK(host='localhost')

# Tester la cam√©ra
try:
    img = reachy.cameras.right.read()
    if img is not None:
        print(f"‚úì Cam√©ra fonctionne - Image shape: {img.shape}")
    else:
        print("‚úó Cam√©ra retourne None")
except Exception as e:
    print(f"‚úó Erreur cam√©ra: {e}")
EOF
```

#### Solution 2 : D√©sactiver temporairement l'attente cam√©ra

Pour tester le code sans la cam√©ra, vous pouvez modifier `wait_for_img()` :

```python
# Dans tictactoe_playground.py, ligne ~675
def wait_for_img(self):
    """Attend qu'une image soit disponible"""
    # TEMPORAIRE : d√©sactiver pour test
    logger.warning('wait_for_img() disabled for testing')
    return
    
    # Code original...
```

### 6. Lancer le jeu

```bash
# Sur le robot
cd ~/dev/Reachy-2021-TicTacToe
source venv/bin/activate

# Lancer avec logs
python -m reachy_tictactoe.game_launcher --log-file /tmp/tictactoe

# Dans un autre terminal, suivre les logs
ssh reachy@192.168.18.170
tail -f /tmp/tictactoe-*.log
```

---

## üêõ Probl√®mes identifi√©s dans les logs

### Probl√®me 1 : Code non d√©ploy√© (Log 1)
```
ValueError: goal_positions keys should be Joint!
```
**Solution** : Suivre les √©tapes 1-4 ci-dessus

### Probl√®me 2 : Erreur `_get_joint_by_name()` (Log 2)
```
Error accessing joint r_arm.r_gripper: argument of type 'DeviceHolder' is not iterable
```
**Solution** : ‚úÖ Corrig√© dans la derni√®re version (utilise `getattr()` au lieu de `in`)

### Probl√®me 3 : Timeout cam√©ra (Log 2)
```
No image received for 30 sec, going to reboot
```
**Solutions possibles** :

1. **V√©rifier que la cam√©ra fonctionne** :
   ```bash
   v4l2-ctl --list-devices
   ```

2. **V√©rifier les permissions** :
   ```bash
   ls -l /dev/video*
   sudo usermod -a -G video reachy
   ```

3. **Red√©marrer le service cam√©ra** (si applicable) :
   ```bash
   sudo systemctl restart camera-service
   ```

4. **Test manuel de la cam√©ra** :
   ```python
   from reachy_sdk import ReachySDK
   import cv2
   
   reachy = ReachySDK(host='localhost')
   
   for i in range(10):
       img = reachy.cameras.right.read()
       if img is not None:
           print(f"‚úì Image {i+1} re√ßue: {img.shape}")
           cv2.imwrite(f'/tmp/test_cam_{i}.jpg', img)
       else:
           print(f"‚úó Image {i+1} None")
       time.sleep(0.5)
   ```

---

## ‚úÖ Checklist de d√©ploiement

- [ ] Fichiers transf√©r√©s vers le robot
- [ ] Package r√©install√© (`pip install -e .`)
- [ ] Test d'importation r√©ussi
- [ ] Cam√©ra v√©rifi√©e et fonctionnelle
- [ ] Logs suivis en temps r√©el
- [ ] Test de lancement sans erreur

---

## üìù Commandes rapides

### D√©ploiement complet (depuis votre machine)

```bash
# 1. Transf√©rer
scp -r reachy_tictactoe/ reachy@192.168.18.170:~/dev/Reachy-2021-TicTacToe/

# 2. Installer et tester (sur le robot)
ssh reachy@192.168.18.170 << 'EOF'
cd ~/dev/Reachy-2021-TicTacToe
source venv/bin/activate
pip install -e .
python -c "from reachy_tictactoe import TictactoePlayground; print('‚úì OK')"
EOF

# 3. Lancer
ssh reachy@192.168.18.170
cd ~/dev/Reachy-2021-TicTacToe
source venv/bin/activate
python -m reachy_tictactoe.game_launcher --log-file /tmp/tictactoe
```

### V√©rification rapide

```bash
# Test sur le robot
ssh reachy@192.168.18.170 "cd ~/dev/Reachy-2021-TicTacToe && source venv/bin/activate && python -c 'from reachy_tictactoe import TictactoePlayground; print(\"‚úì OK\")'"
```

---

## üîß D√©pannage

### Si `goto()` donne encore l'erreur "keys should be Joint"

```bash
# V√©rifier que c'est bien le bon fichier
ssh reachy@192.168.18.170
grep -n "self.reachy.head.l_antenna" ~/dev/Reachy-2021-TicTacToe/reachy_tictactoe/tictactoe_playground.py

# Devrait retourner plusieurs lignes avec les objets Joint
```

### Si la cam√©ra ne fonctionne pas

```bash
# Option 1: Commenter temporairement wait_for_img()
# Option 2: Utiliser une image de test
# Option 3: V√©rifier les drivers
lsmod | grep video
```

### Si le robot reboot constamment

```bash
# D√©sactiver le auto-reboot dans wait_for_img()
# Ligne 683 : Commenter os.system('sudo reboot')
```

---

## üìû Support

Si les probl√®mes persistent :

1. V√©rifier les logs complets : `cat /tmp/tictactoe-*.log`
2. V√©rifier l'√©tat du robot : `systemctl status reachy`
3. Consulter la documentation : [docs.pollen-robotics.com](https://docs.pollen-robotics.com/)
4. Forum : [forum.pollen-robotics.com](https://forum.pollen-robotics.com/)

---

**Apr√®s ces √©tapes, le code corrig√© devrait fonctionner sur le robot !** üöÄ

